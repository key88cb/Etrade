# 数据模块开发指南

## Python

### 版本

Python 版本 3.12

### 缩进和换行

缩进是四个空格，换行理论上是有些东西之间必须换行，比如两个函数的定义之间，不过都不用在意，这里也用格式化工具统一

安装`black`

```bash
pip install black
```

使用

```bash
black .
```

### 命名规范

Python 中的变量是`snake_case`，类名是`CamelCase`

### 函数规范

**不使用**类型提示，类型提示感觉是徒增麻烦，但对于**重要或复杂的函数**要写文档注释，用中文，如下所示

```py
def f():
    """
    描述：这是一个XXX的函数
    参数：...
    返回值：...
    """
    pass
```

### 导入规范

不需要特意关注，这个使用`isort`工具保证

下载`isort`工具

```bash
pip install isort
```

格式化当前目录的全部导入，`black`和`isort`偶尔会冲突，所以需要指定`isort`使用`black`兼容模式

```bash
isort --profile black .
```

### 库配置文件

这个不需要手动输入，可以使用`pipreqs`自动生成`requirements.txt`，如果需要覆盖则添加`--force`参数

安装`pipreqs`

```bash
pip install pipreqs
```

```bash
# 指定输出为兼容模式
pipreqs . --force --mode compat
```

### 单元测试

Python 内置的`unittest`模块并不好用，这里选择使用`pytest`，它功能强大、语法简洁，它直接使用Python内置的`assert`（本质是抛出`AssertionError`）进行断言。单元测试一般遵循AAA原则：

- Arrange：组织测试数据
- Act：执行相应逻辑，某些依赖可能是mock（模拟）的
- Assert：执行断言，判断结果是否符合预期

下面是一个典型的单元测试示例，运行它只需使用`pytest`指令。此外，为了方便识别测试代码文件，要求所有测试文件名都以`test_`开头。

```py
# test_example.py

def add(a, b):
    return a + b

def test_add_positive_numbers():
    """测试两个正数相加"""
    assert add(1, 2) == 3

def test_add_negative_numbers():
    """测试两个负数相加"""
    assert add(-1, -1) == -2

def test_add_zero():
    """测试与零相加"""
    assert add(5, 0) == 5

# 检查异常（例如除零错误）
import pytest 

def divide(a, b):
    return a / b

def test_divide_by_zero():
    with pytest.raises(ZeroDivisionError):
        divide(1, 0)
```

`pytest`的常见用法如下：

1. `pytest`：测试当前文件夹下所有代码
2. `pytest name.py`：测试指定文件
3. `pytest -v`：输出详细信息
4. `pytest --cov=folder --cov-report=html`：测试并生成覆盖率报告（`html`），`folder`是源代码目录

### 其它注意事项

1. 在 vscode 和 cursor 之类的编辑器里面，通过插件运行`python`会默认运行路径是在当前打开的文件夹下，比如我打开整个Etrade项目，然后F5运行`etrade/data`目录下的Python代码，代码是跑在`etrade/`目录下的，这个主要会引发一些相对路径的问题。
2. `analyse.py` 支持通过命令行参数限定分析时间段，例如：
   ```bash
   python analyse.py --start 2025-09-01T00:00:00Z --end 2025-09-07T23:59:59Z
   ```
   如果不指定 `--start/--end`，默认分析全量数据。
3. `python`的包一定需要`__init__.py`，即使其中没有内容，其作用是在导入包时进行一些初始化操作
4. `python`的本地包搜索默认是从当前目录往下，如果要往上搜索，需要通过`os`和`sys`添加搜索路径
